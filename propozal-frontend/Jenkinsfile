pipeline {
  agent any

  options {
    timeout(time: 30, unit: 'MINUTES')
    disableConcurrentBuilds()
    durabilityHint('PERFORMANCE_OPTIMIZED')
    timestamps()
  }

  environment {
    IMAGE       = 'propozal-frontend:latest'
    CONTAINER   = 'propozal-frontend'
    FRONTEND_DIR = 'propozal-frontend'
    HOST_PORT   = '3000'
  }

  tools { nodejs 'node-20' } // Jenkinsì— Node.js 20.x ë“±ë¡ í•„ìš”

  stages {
    stage('Checkout') {
      steps {
        echo 'ğŸ“¦ Checkout from SCM'
        checkout scm
      }
    }

    stage('Install & Build') {
      steps {
        dir("${FRONTEND_DIR}") {
          sh '''
            #!/usr/bin/env bash
            set -e

            echo "ğŸ“¥ Installing dependencies"
            npm ci

            echo "ğŸ—ï¸ Building production bundle"
            npm run build
          '''
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        echo "ğŸ³ Docker build: ${IMAGE}"
        sh 'docker build -t $IMAGE $FRONTEND_DIR'
      }
    }

    stage('Deploy Container') {
      steps {
        echo 'ğŸ§¹ Stop & remove previous container (if any)'
        sh '''
          docker stop $CONTAINER || true
          docker rm $CONTAINER || true
        '''
        echo 'ğŸš€ Run new container'
        sh '''
          docker run -d --name $CONTAINER \
            --restart unless-stopped \
            -p 127.0.0.1:${HOST_PORT}:80 \
            $IMAGE
        '''
      }
    }

    stage('Smoke Test') {
      options { timeout(time: 2, unit: 'MINUTES') }
      steps {
        echo 'ğŸ©º Smoke test'
        sh '''
          curl -fsS http://127.0.0.1:${HOST_PORT} >/dev/null
        '''
      }
    }
  }

  post {
    success { echo 'âœ… Frontend Build & Deployment Success!' }
    failure { echo 'âŒ Build Failed' }
    always  { sh 'docker image prune -f || true' }
  }
}
