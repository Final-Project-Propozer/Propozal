pipeline {
  agent any

  options {
    timeout(time: 30, unit: 'MINUTES')
    disableConcurrentBuilds()
    durabilityHint('MAX_SURVIVABILITY')
    timestamps()
  }

  environment {
    IMAGE       = 'propozal-backend:latest'
    CONTAINER   = 'propozal-backend'
    BACKEND_DIR = 'propozal-backend'
    ENV_FILE    = '/srv/Propozal/propozal-backend/.env'
    HOST_PORT   = '8081'
    GRADLE_USER_HOME = '/var/lib/jenkins/.gradle'
  }

  tools { gradle 'gradle-8.10.2' }

  stages {
    stage('Checkout') {
      steps {
        echo '📦 Checkout from SCM (job branch setting respected)'
        checkout scm
      }
    }

    stage('Build Jar') {
      options { timeout(time: 15, unit: 'MINUTES') }
      steps {
        echo '🔧 Gradle build (skip tests, cached, heartbeat)'
        dir("${BACKEND_DIR}") {
          sh '''#!/usr/bin/env bash
          set -euo pipefail
          gradle --no-daemon --console=plain --build-cache --max-workers=2 \
                -Dorg.gradle.logging.stacktrace=all \
                clean bootJar -x test
          '''
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        echo "🐳 Docker build: ${IMAGE}"
        withEnv(['DOCKER_BUILDKIT=0']) {
          sh '''
            set -e
            # 1) JAR 존재 확인하고 컨텍스트로 복사
            ls -l propozal-backend/build/libs || true
            cp -f propozal-backend/build/libs/*.jar propozal-backend/app.jar

            # 2) 이미지 빌드
            docker build -t $IMAGE $BACKEND_DIR

            # 3) 청소(선택)
            rm -f propozal-backend/app.jar || true
          '''
        }
      }
    }

    stage('Deploy Container') {
      steps {
        echo '🧹 Stop & remove previous container (if any)'
        sh '''
          docker stop $CONTAINER || true
          docker rm $CONTAINER || true
        '''
        echo '🚀 Run new container'
        sh '''
          docker run -d --name $CONTAINER \
            --restart unless-stopped \
            --env-file $ENV_FILE \
            --add-host=host.docker.internal:host-gateway \
            -p 127.0.0.1:${HOST_PORT}:8080 \
            $IMAGE
        '''
      }
    }

    stage('Smoke Test') {
      options { timeout(time: 2, unit: 'MINUTES') }
      steps {
        tool name: 'curl', type: 'org.jenkinsci.plugins.curl.CurlTool' // 있으면, 없으면 자동 curl 사용
        withEnv(["HOST_PORT=${HOST_PORT ?: '8081'}"]) {
          echo '🩺 Smoke test (wait for Spring Boot to be ready)'

          sh '''
            set +e  # 재시도 루프가 실패해도 즉시 종료하지 않게
            HEALTH_URL="http://127.0.0.1:${HOST_PORT}/actuator/health"

            echo "⏳ Waiting for port ${HOST_PORT} to accept connections..."
            for i in $(seq 1 40); do
              (exec 3<>/dev/tcp/127.0.0.1/${HOST_PORT}) 2>/dev/null && { echo "✅ Port open"; break; }
              echo "  ...port not open yet (${i}/40)"
              sleep 3
            done

            echo "🔎 Probing actuator health until UP..."
            success=0
            for i in $(seq 1 40); do
              # 응답 코드와 바디를 분리해서 확보
              code=$(curl -sS -m 3 -o /tmp/health_body -w "%{http_code}" "$HEALTH_URL")
              body="$(cat /tmp/health_body || true)"

              # 디버그 출력(줄여서)
              echo "  try ${i}: http ${code} $(echo "$body" | tr -d "\\n" | cut -c1-120)"

              # 200이면서 "status":"UP" 이면 성공
              echo "$body" | grep -q '"status"[[:space:]]*:[[:space:]]*"UP"' && [ "$code" = "200" ] && { success=1; break; }

              # 아직 준비 안 됐을 때(503 DOWN/401 Unauthorized 등)는 잠시 대기 후 재시도
              sleep 3
            done

            if [ "$success" -ne 1 ]; then
              echo "❌ Smoke test failed. Dumping last logs..."
              docker logs --tail 200 propozal-backend || true
              exit 1
            fi

            echo "✅ Smoke test passed: ${HEALTH_URL} is UP"
          '''
        }
      }
    }
  }

  post {
    failure {
      echo '❌ Build Failed — generating Gradle profile report for diagnosis'
      dir("${BACKEND_DIR}") {
        sh '''#!/usr/bin/env bash
        set -euo pipefail
        gradle --no-daemon --console=plain help --scan || true
        '''
      }
    }
    success { echo '✅ Backend Build & Deployment Success!' }
    always  { sh 'docker image prune -f || true' }
  }
}
