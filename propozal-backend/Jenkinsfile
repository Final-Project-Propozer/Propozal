pipeline {
  agent any

  options {
    timeout(time: 30, unit: 'MINUTES')
    disableConcurrentBuilds()
    durabilityHint('MAX_SURVIVABILITY')
    timestamps()
  }

  environment {
    IMAGE       = 'propozal-backend:latest'
    CONTAINER   = 'propozal-backend'
    BACKEND_DIR = 'propozal-backend'
    ENV_FILE    = '/srv/Propozal/propozal-backend/.env'
    HOST_PORT   = '8081'
    GRADLE_USER_HOME = '/var/lib/jenkins/.gradle'
  }

  tools { gradle 'gradle-8.10.2' }

  stages {
    stage('Checkout') {
      steps {
        echo 'ğŸ“¦ Checkout from SCM (job branch setting respected)'
        checkout scm
      }
    }

    stage('Build Jar') {
      options { timeout(time: 15, unit: 'MINUTES') }
      steps {
        echo 'ğŸ”§ Gradle build (skip tests, cached, heartbeat)'
        dir("${BACKEND_DIR}") {
          sh '''#!/usr/bin/env bash
          set -euo pipefail
          gradle --no-daemon --console=plain --build-cache --max-workers=2 \
                -Dorg.gradle.logging.stacktrace=all \
                clean bootJar -x test
          '''
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        echo "ğŸ³ Docker build: ${IMAGE}"
        withEnv(['DOCKER_BUILDKIT=0']) {
          sh '''
            set -e
            # 1) JAR ì¡´ì¬ í™•ì¸í•˜ê³  ì»¨í…ìŠ¤íŠ¸ë¡œ ë³µì‚¬
            ls -l propozal-backend/build/libs || true
            cp -f propozal-backend/build/libs/*.jar propozal-backend/app.jar

            # 2) ì´ë¯¸ì§€ ë¹Œë“œ
            docker build -t $IMAGE $BACKEND_DIR

            # 3) ì²­ì†Œ(ì„ íƒ)
            rm -f propozal-backend/app.jar || true
          '''
        }
      }
    }

    stage('Deploy Container') {
      steps {
        echo 'ğŸ§¹ Stop & remove previous container (if any)'
        sh '''
          docker stop $CONTAINER || true
          docker rm $CONTAINER || true
        '''
        echo 'ğŸš€ Run new container'
        sh '''
          docker run -d --name $CONTAINER \
            --restart unless-stopped \
            --env-file $ENV_FILE \
            --add-host=host.docker.internal:host-gateway \
            -p 127.0.0.1:${HOST_PORT}:8080 \
            $IMAGE
        '''
      }
    }
    stage('Smoke Test') {
      options { timeout(time: 4, unit: 'MINUTES') }
      steps {
        withEnv(["HOST_PORT=${HOST_PORT ?: '8081'}"]) {
          echo 'ğŸ©º Smoke test (wait for Spring Boot to be ready via logs)'
          sh '''
            set -e

            # 1) ì»¨í…Œì´ë„ˆ ë¡œê·¸ì—ì„œ "Started ...Application" or "Tomcat started on port" ë‚˜ì˜¬ ë•Œê¹Œì§€ ëŒ€ê¸°
            echo "â³ Waiting app startup messages in docker logs..."
            ready=0
            for i in $(seq 1 60); do
              if docker logs --tail 200 propozal-backend 2>&1 | grep -Eq "Started .*Application|Tomcat started on port"; then
                echo "âœ… Spring Boot startup detected in logs"
                ready=1
                break
              fi
              sleep 3
            done
            if [ "$ready" -ne 1 ]; then
              echo "âŒ App did not signal startup in logs"
              docker logs --tail 300 propozal-backend || true
              exit 1
            fi

            # 2) /actuator/health ì¬ì‹œë„ (401/503ë„ ì´ˆê¸°ì—” ë‚˜ì˜¬ ìˆ˜ ìˆìŒ)
            HEALTH_URL="http://127.0.0.1:${HOST_PORT}/actuator/health"
            echo "ğŸ” Probing health: $HEALTH_URL"
            ok=0
            for i in $(seq 1 30); do
              # curl ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ wget
              if command -v curl >/dev/null 2>&1; then
                code=$(curl -sS -m 5 -o /tmp/health_body -w "%{http_code}" "$HEALTH_URL" || echo 000)
                body="$(cat /tmp/health_body 2>/dev/null || true)"
              else
                code=$(wget -q --server-response -O /tmp/health_body "$HEALTH_URL" 2>&1 | awk '/^  HTTP/{print $2}' | tail -1)
                body="$(cat /tmp/health_body 2>/dev/null || true)"
              fi

              echo "  try ${i}: http ${code} $(echo "$body" | tr -d "\\n" | cut -c1-120)"

              # ë³´ì•ˆ ì„¤ì •ì— ë”°ë¼ 200/UP ë˜ëŠ” 401ì´ ì˜¬ ìˆ˜ ìˆìŒ.
              # 200ì´ë©´ì„œ "UP"ì´ë©´ í•©ê²©. 401ì´ë©´ ë³´ì•ˆìœ¼ë¡œ ë§‰íŒ ê²ƒë¿ì´ë¼ 'ê¸°ë™ì€ ì„±ê³µ'ìœ¼ë¡œ ê°„ì£¼í•˜ê³  í†µê³¼ì‹œì¼œë„ ë¨.
              if echo "$body" | grep -q '"status"[[:space:]]*:[[:space:]]*"UP"'; then
                ok=1; break
              fi
              if [ "$code" = "401" ]; then
                echo "â„¹ï¸  health endpoint requires auth (HTTP 401) â€” app is up. Treating as PASS."
                ok=1; break
              fi
              sleep 3
            done

            if [ "$ok" -ne 1 ]; then
              echo "âŒ Health check not UP"
              docker logs --tail 300 propozal-backend || true
              exit 1
            fi

            echo "âœ… Smoke test passed"
          '''
        }
      }
    }
  }

  post {
    failure {
      echo 'âŒ Build Failed â€” generating Gradle profile report for diagnosis'
      dir("${BACKEND_DIR}") {
        sh '''#!/usr/bin/env bash
        set -euo pipefail
        gradle --no-daemon --console=plain help --scan || true
        '''
      }
    }
    success { echo 'âœ… Backend Build & Deployment Success!' }
    always  { sh 'docker image prune -f || true' }
  }
}
